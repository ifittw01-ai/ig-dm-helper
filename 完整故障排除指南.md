# 完整故障排除指南 🔧

## 🎯 快速修复步骤

如果程序一直崩溃或出现错误，请按照以下步骤操作：

### 步骤 1：清理残留数据 ⚠️ **重要**

删除以下文件（如果存在）：
```
C:\Projects\ig-dm-helper\cookies.json
C:\Projects\ig-dm-helper\session.json
C:\Projects\ig-dm-helper\ig-dm.db
```

**为什么？** 这些文件可能包含损坏的 Session 数据，导致程序崩溃。

### 步骤 2：重新启动程序

```bash
npm start
```

### 步骤 3：正确的使用流程

1. ✅ **点击【初始化】** - 等待成功提示
2. ✅ **点击【登入】** - 输入 Instagram 账号密码
3. ✅ **确认登入成功** - 看到欢迎消息
4. ✅ **匯入帳號清單** - 选择要发送的用户列表
5. ✅ **输入訊息文案** - 准备发送的消息
6. ✅ **点击【開始群發】** - 开始逐个处理

## 🚨 常见错误及解决方案

### 错误 1: FATAL ERROR (程序崩溃)

```
FATAL ERROR: Error::ThrowAsJavaScriptException napi_throw
```

**原因**：未登入状态下尝试群发，导致大量 API 错误

**解决方案**：
1. 删除 `cookies.json` 和 `session.json`
2. 重新启动程序
3. **必须先登入**再群发

---

### 错误 2: Cannot read properties of undefined

```
錯誤：Cannot read properties of undefined (reading 'style')
```

**原因**：DOM 元素名称不匹配（已修复）

**解决方案**：
1. 确保使用最新版本的代码
2. 重新启动程序

---

### 错误 3: Attempted to register a second handler

```
Error: Attempted to register a second handler for 'check-login-status'
```

**原因**：重复注册 IPC 处理器（已修复）

**解决方案**：
1. 确保使用最新版本的 `main.js`
2. 完全关闭 Electron 窗口后重启

---

### 错误 4: 401 Unauthorized

```
Instagram API Error: {
  status: 401,
  statusText: 'Unauthorized'
}
```

**原因**：未登入或 Session 过期

**解决方案**：
1. 点击【登入】按钮
2. 输入正确的账号密码
3. 等待登入成功提示

---

### 错误 5: Maximum number of redirects exceeded

```
Maximum number of redirects exceeded
```

**原因**：Instagram 检测到异常请求

**解决方案**：
1. 停止所有操作
2. 等待 5-10 分钟
3. 重新登入
4. 减少发送频率（每批次 < 10 个用户）

---

### 错误 6: 中文亂碼

```
?豢?摨恍???
```

**原因**：Windows 终端编码问题

**解决方案**：
使用 `run.bat` 启动（自动修复编码）：
```bash
run.bat
```

或手动设置：
```bash
chcp 65001
npm start
```

## 📋 完整检查清单

在开始使用前，请确认：

- [ ] 已删除旧的 `cookies.json`、`session.json`、`ig-dm.db`
- [ ] 已重新启动程序
- [ ] 已点击【初始化】按钮
- [ ] 已点击【登入】按钮并成功登入
- [ ] 已看到"歡迎"或"已登入"提示
- [ ] 已匯入帳號清單
- [ ] 已输入訊息文案
- [ ] 网络连接正常

## 🔍 诊断步骤

### 如果程序启动就崩溃：

1. **查看终端日志**
   - 是否有大量 401 错误？ → 删除 cookies.json
   - 是否有 `Attempted to register` 错误？ → 确保代码是最新版本
   - 是否有亂碼？ → 使用 run.bat 启动

2. **检查文件**
   ```bash
   # 删除这些文件
   del cookies.json
   del session.json
   del ig-dm.db
   ```

3. **重新启动**
   ```bash
   npm start
   ```

### 如果点击群发后崩溃：

1. **确认已登入**
   - 看到错误提示 → 点击【登入】
   - 没有提示 → 继续下一步

2. **检查账号清单**
   - 格式是否正确？（每行一个用户名）
   - 是否有特殊字符？

3. **减少发送数量**
   - 先测试 1-2 个用户
   - 成功后再增加数量

## 🎬 从零开始的完整流程

### 1. 清理环境

```powershell
# 在项目目录下
cd C:\Projects\ig-dm-helper

# 删除旧数据
if (Test-Path cookies.json) { Remove-Item cookies.json }
if (Test-Path session.json) { Remove-Item session.json }
if (Test-Path ig-dm.db) { Remove-Item ig-dm.db }
```

### 2. 启动程序

```bash
# 方法 1：使用批处理（推荐）
run.bat

# 方法 2：手动启动
npm start
```

### 3. 初始化和登入

1. 程序打开后，**不要直接点击群发**
2. 点击【初始化】按钮
3. 等待提示："Instagram API 初始化成功"
4. 点击【登入】按钮
5. 输入 Instagram 用户名（不带 @）
6. 输入 Instagram 密码
7. 等待提示："歡迎，[用户名]！"

### 4. 准备群发

1. 点击【匯入清單】
2. 选择 TXT 文件（每行一个用户名）
3. 确认用户列表显示正确
4. 在訊息文案框中输入消息

### 5. 开始群发

1. 点击【開始群發】
2. 看到确认对话框 → 点击【確定】
3. 瀏覽器自动打开第一个用户页面
4. 在应用中看到确认对话框
5. 检查瀏覽器中是否有【訊息】按钮
6. 在应用中选择操作：
   - ✅ 可以發送 → 发送消息
   - ⏭️ 跳過 → 跳过该用户
   - 🛑 停止 → 停止群发

## ⚠️ 重要提示

### 必须按顺序操作

```
❌ 错误流程：
启动程序 → 直接点击群发 → 💥 崩溃

✅ 正确流程：
启动程序 → 初始化 → 登入 → 匯入清單 → 群发 → ✅ 成功
```

### Session 管理

- **首次使用**：必须登入
- **再次使用**：如果 Session 有效，会自动登入
- **Session 过期**：看到 401 错误时，重新登入

### 发送限制

建议：
- 每批次 < 10 个用户
- 每个用户之间延迟 2-3 秒
- 每小时总发送 < 30 条
- 避免在短时间内大量操作

## 📞 仍然无法解决？

### 收集诊断信息

1. **终端日志**
   - 复制所有错误信息
   - 注意 401、404、500 等状态码

2. **错误对话框**
   - 截图保存
   - 记录错误信息

3. **操作步骤**
   - 记录你做了什么
   - 何时出现错误

### 高级故障排除

```bash
# 1. 清理 node_modules 并重新安装
rm -rf node_modules
npm install

# 2. 清理缓存
npm cache clean --force

# 3. 检查 Node.js 版本
node --version
# 应该是 v14 或更高

# 4. 检查 Electron 版本
npm list electron
```

## 🎉 成功标志

当你看到以下内容时，说明一切正常：

### 启动成功
```
✅ Instagram API 初始化成功
```

### 登入成功
```
✅ 已登入
歡迎，[你的用户名]！
```

### 群发开始
```
🌐 打開用戶頁面
正在處理 @username (1/10)
```

### 发送成功
```
✅ 完成
發送完成！成功: 5, 跳過: 2, 失敗: 0
```

## 📚 相关文档

- [修復崩潰問題-說明.md](修復崩潰問題-說明.md) - 崩溃问题详解
- [逐個發送-使用說明.md](逐個發送-使用說明.md) - 功能使用指南
- [API_ERROR_GUIDE.md](API_ERROR_GUIDE.md) - API 错误解决
- [START_HERE.md](START_HERE.md) - 完整项目文档

---

**记住最重要的一点：永远先登入，再群发！** 🔑

祝使用顺利！ 🎊

