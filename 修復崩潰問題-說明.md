# 修復 FATAL ERROR 崩潰問題

## ❌ 問題描述

當你在**未登入**的狀態下點擊【開始群發】時，程序會崩潰並顯示：

```
FATAL ERROR: Error::ThrowAsJavaScriptException napi_throw
```

### 崩潰原因

1. **未登入狀態**：程序嘗試在未登入 Instagram 的情況下發送大量 API 請求
2. **401 Unauthorized**：Instagram API 返回大量未授權錯誤
3. **Maximum redirects**：請求被重定向次數超限
4. **NAPI 崩潰**：大量錯誤導致 Node.js 原生模組崩潰

### 終端日志示例

```
?? 帳號可能被限制，嚴重錯誤：
   1. 帳號需要驗證Challenge
   2. Session 已過期
   3. 帳號被封鎖

Instagram API Error: {
  url: '/api/v1/users/web_profile_info/',
  method: 'get',
  status: 401,
  statusText: 'Unauthorized'
}

Maximum number of redirects exceeded

FATAL ERROR: Error::ThrowAsJavaScriptException napi_throw
```

## ✅ 解決方案

### 1. 添加登入狀態檢查

程序現在會在開始群發前自動檢查登入狀態：

```javascript
// 檢查登入狀態
const loginStatus = await ipcRenderer.invoke('check-login-status');
if (!loginStatus.loggedIn) {
    alert('❌ 請先登入 Instagram');
    return;
}
```

### 2. 改進錯誤處理

添加多層錯誤邊界：

- **外層邊界**：捕獲嚴重錯誤，防止程序崩潰
- **內層邊界**：捕獲單個用戶的發送錯誤
- **登入檢查**：每次發送前驗證 Session 有效性

### 3. 智能錯誤恢復

- 檢測到登入錯誤時自動停止
- 單個用戶失敗時詢問是否繼續
- 顯示詳細的錯誤信息和已完成統計

## 🚀 正確使用流程

### 第一步：初始化和登入

1. **啟動程序**
   ```bash
   npm start
   ```

2. **點擊【初始化】按鈕**
   - 等待顯示 "Instagram API 初始化成功"

3. **點擊【登入】按鈕**
   - 輸入您的 Instagram 用戶名
   - 輸入您的 Instagram 密碼
   - 等待登入成功提示

4. **確認登入狀態**
   - 如果之前已經登入，會顯示 "已載入先前的登入狀態"
   - 首次登入後，下次啟動會自動恢復登入

### 第二步：準備群發

5. **匯入帳號清單**
   - 點擊【匯入清單】
   - 選擇包含用戶名的 TXT 文件
   - 確認用戶列表顯示正確

6. **輸入訊息文案**
   - 在訊息輸入框中輸入要發送的內容

### 第三步：開始群發

7. **點擊【開始群發】**
   - ✅ 如果已登入：開始逐個處理用戶
   - ❌ 如果未登入：顯示錯誤提示，阻止操作

## ⚠️ 注意事項

### 必須先登入

**永遠記住：必須先完成初始化和登入，才能使用群發功能！**

如果你看到以下錯誤提示，說明未登入：

```
❌ 無法開始群發

原因：未登入或 Session 已過期

請先完成以下步驟：
1. 點擊【初始化】按鈕
2. 點擊【登入】按鈕
3. 輸入您的 Instagram 帳號密碼
4. 確認登入成功後再試

⚠️ 注意：未登入狀態下發送會導致程序崩潰！
```

### Session 過期

如果 Session 過期（通常是幾天後），你會看到：

```
❌ 檢測到登入問題

錯誤：未登入或 Session 已過期，請重新登入

批量發送已停止。請重新登入後再試。
```

**解決方法**：重新點擊【登入】按鈕登入即可。

### 401 Unauthorized 錯誤

如果在發送過程中看到 401 錯誤：

1. **停止當前操作**
2. **重新登入**
3. **等待幾分鐘**（避免觸發 Instagram 限制）
4. **再次嘗試**

## 🔧 技術改進

### 修改的文件

#### 1. `main.js`
- ✅ 添加 `check-login-status` IPC 處理器
- ✅ 在 `send-single-dm` 中添加登入檢查
- ✅ 改進錯誤處理和提示

```javascript
// 檢查登入狀態
ipcMain.handle('check-login-status', async (event) => {
    if (!igAPI) {
        return { loggedIn: false, message: '尚未初始化' };
    }
    
    const isLoggedIn = await igAPI.checkLoginStatus();
    return { 
        loggedIn: isLoggedIn,
        message: isLoggedIn ? '已登入' : '未登入或 Session 已過期'
    };
});
```

#### 2. `renderer.js`
- ✅ 在 `startBatchDM` 前檢查登入狀態
- ✅ 添加多層錯誤邊界（外層 + 內層）
- ✅ 智能錯誤處理和用戶提示
- ✅ 檢測登入錯誤時自動停止

```javascript
// 檢查登入狀態
const loginStatus = await ipcRenderer.invoke('check-login-status');
if (!loginStatus.loggedIn) {
    alert('❌ 請先登入');
    return;
}
```

### 錯誤邊界結構

```
┌─ startBatchDM (外層 try-catch)
│   │
│   ├─ for loop (逐個處理)
│   │   │
│   │   └─ 內層 try-catch (單個用戶)
│   │       ├─ 打開瀏覽器
│   │       ├─ 詢問確認
│   │       └─ 發送訊息
│   │           └─ send-single-dm
│   │               └─ 檢查登入狀態
│   │
│   └─ 捕獲嚴重錯誤
│
└─ 顯示最終統計
```

## 📊 錯誤處理流程

### 級別 1：預防（啟動前）
```
開始群發 → 檢查登入狀態 → ❌ 未登入 → 阻止並提示
                         → ✅ 已登入 → 繼續
```

### 級別 2：檢測（發送時）
```
發送訊息 → send-single-dm → 檢查登入 → ❌ Session 過期 → 返回錯誤
                                      → ✅ 有效 → 發送
```

### 級別 3：恢復（錯誤時）
```
單個用戶失敗 → 記錄錯誤 → 是登入錯誤？ → ❌ 是 → 停止全部
                                      → ❌ 否 → 詢問是否繼續
```

### 級別 4：保護（崩潰前）
```
嚴重錯誤 → 外層 catch → 顯示統計 → 安全停止
```

## 🎯 測試步驟

### 測試 1：未登入保護
1. 啟動程序但**不要登入**
2. 匯入帳號清單
3. 點擊【開始群發】
4. **預期**：看到錯誤提示，程序不崩潰

### 測試 2：正常流程
1. 點擊【初始化】
2. 點擊【登入】並輸入帳號
3. 匯入帳號清單
4. 點擊【開始群發】
5. **預期**：瀏覽器打開，顯示確認對話框

### 測試 3：Session 過期
1. 手動刪除 `cookies.json`（模擬 Session 過期）
2. 重啟程序
3. 不要重新登入，直接匯入清單
4. 點擊【開始群發】
5. **預期**：看到錯誤提示，程序不崩潰

## 💡 最佳實踐

### 每次使用前
1. ✅ 確認已登入
2. ✅ 檢查網絡連接
3. ✅ 準備好帳號清單
4. ✅ 測試發送 1-2 個帳號

### 使用過程中
1. ✅ 不要頻繁操作
2. ✅ 每批次 < 20 個用戶
3. ✅ 遇到錯誤及時停止
4. ✅ Session 過期立即重新登入

### 錯誤處理
1. ✅ 看到 401 錯誤 → 重新登入
2. ✅ Maximum redirects → 等待後重試
3. ✅ 程序崩潰 → 查看終端日志
4. ✅ 持續失敗 → 檢查 Instagram 帳號狀態

## 📚 相關文檔

- [API_ERROR_GUIDE.md](API_ERROR_GUIDE.md) - API 錯誤詳細說明
- [逐個發送-使用說明.md](逐個發送-使用說明.md) - 功能使用指南
- [START_HERE.md](START_HERE.md) - 完整項目文檔

## ❤️ 問題已修復

✅ **添加登入狀態檢查**  
✅ **多層錯誤邊界保護**  
✅ **智能錯誤恢復機制**  
✅ **詳細錯誤提示信息**  
✅ **防止程序崩潰**  

現在程序更加穩定和安全！

---

**更新日期：** 2025-11-01  
**版本：** 1.1.1

